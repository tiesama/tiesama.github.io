<index.html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>预应力损失σl6完整参数影响分析</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', SimHei, Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        .value-display {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: darkred;
            background-color: yellow;
            border: 3px solid red;
            border-radius: 10px;
            padding: 15px;
            margin: 20px auto;
            max-width: 900px;
        }
        .section-title {
            background: linear-gradient(to right, #4CAF50, #45a049);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 20px 0 10px 0;
            font-size: 16px;
            font-weight: bold;
        }
        .row-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .row-container-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .plot-wrapper {
            background-color: #fafafa;
            border-radius: 5px;
            padding: 10px;
        }
        .sensitivity-plot {
            margin-top: 20px;
        }
        .slider-container {
            margin: 10px 0;
        }
        .slider-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        input[type="range"] {
            width: 100%;
            height: 25px;
        }
        .slider-value {
            text-align: center;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>预应力损失σl6完整参数影响分析（交互式网页版）</h1>
        
        <div class="value-display" id="valueDisplay">
            当前预应力损失: σl6 = 125.38 MPa (收缩贡献: 14.74 MPa + 徐变贡献: 110.64 MPa)
        </div>

        <div class="section-title">第一行：显性影响变量（影响量大）- 收缩应变εcs 和 徐变系数φ</div>
        <div class="row-container">
            <div class="plot-wrapper"><div id="plot0"></div></div>
            <div class="plot-wrapper"><div id="plot1"></div></div>
        </div>

        <div class="section-title">第二行：显性影响变量（影响量较小）- 配筋率ρ 和 偏心距ep</div>
        <div class="row-container">
            <div class="plot-wrapper"><div id="plot2"></div></div>
            <div class="plot-wrapper"><div id="plot3"></div></div>
        </div>

        <div class="section-title">第三行：隐性影响变量 - 龄期t₀、相对湿度RH、理论厚度h（影响φ和εcs）</div>
        <div class="row-container-3">
            <div class="plot-wrapper"><div id="plot4"></div></div>
            <div class="plot-wrapper"><div id="plot5"></div></div>
            <div class="plot-wrapper"><div id="plot6"></div></div>
        </div>

        <div class="section-title">第四行：敏感性分析对比图（柱子越高影响越大）</div>
        <div class="plot-wrapper sensitivity-plot"><div id="sensitivity"></div></div>
    </div>

    <script>
        // ==================== 固定参数 ====================
        const E_p = 195000;
        const alpha_EP = 5.65;
        const sigma_pc = 15.0568;
        const A_n = 6932.735;
        const I_n = 23890996.95;

        // ==================== 查表数据 ====================
        const phi_table = {
            3: {100: 3.78, 150: 3.44, 200: 3.24, 300: 3.00, 600: 2.64},
            7: {100: 3.00, 150: 2.74, 200: 2.58, 300: 2.39, 600: 2.11},
            14: {100: 2.51, 150: 2.30, 200: 2.16, 300: 2.01, 600: 1.78},
            28: {100: 2.15, 150: 1.97, 200: 1.86, 300: 1.73, 600: 1.53},
            60: {100: 1.78, 150: 1.63, 200: 1.54, 300: 1.43, 600: 1.27},
            90: {100: 1.65, 150: 1.51, 200: 1.43, 300: 1.32, 600: 1.17}
        };

        const eps_cs_table_80 = {
            3: {100: 0.27, 150: 0.26, 200: 0.25, 300: 0.24, 600: 0.22},
            7: {100: 0.26, 150: 0.25, 200: 0.24, 300: 0.23, 600: 0.21},
            14: {100: 0.25, 150: 0.24, 200: 0.24, 300: 0.23, 600: 0.21},
            28: {100: 0.24, 150: 0.23, 200: 0.22, 300: 0.21, 600: 0.19},
            60: {100: 0.22, 150: 0.21, 200: 0.21, 300: 0.20, 600: 0.18},
            90: {100: 0.21, 150: 0.20, 200: 0.19, 300: 0.18, 600: 0.17}
        };

        const eps_cs_table_50 = {
            3: {100: 0.40, 150: 0.38, 200: 0.37, 300: 0.35, 600: 0.31},
            7: {100: 0.39, 150: 0.38, 200: 0.36, 300: 0.35, 600: 0.31},
            14: {100: 0.38, 150: 0.37, 200: 0.36, 300: 0.34, 600: 0.30},
            28: {100: 0.38, 150: 0.37, 200: 0.35, 300: 0.33, 600: 0.29},
            60: {100: 0.38, 150: 0.36, 200: 0.35, 300: 0.33, 600: 0.28},
            90: {100: 0.38, 150: 0.36, 200: 0.34, 300: 0.32, 600: 0.27}
        };

        // ==================== 双线性插值函数 ====================
        function bilinearInterpolate(x, y, x1, x2, y1, y2, q11, q12, q21, q22) {
            const r1 = ((x2 - x) / (x2 - x1)) * q11 + ((x - x1) / (x2 - x1)) * q21;
            const r2 = ((x2 - x) / (x2 - x1)) * q12 + ((x - x1) / (x2 - x1)) * q22;
            return ((y2 - y) / (y2 - y1)) * r1 + ((y - y1) / (y2 - y1)) * r2;
        }

        function getPhiEpsFromTable(age, thickness, RH) {
            const age_keys = [3, 7, 14, 28, 60, 90];
            const thickness_keys = [100, 150, 200, 300, 600];
            
            let age1 = age_keys[0], age2 = age_keys[age_keys.length - 1];
            for (let i = 0; i < age_keys.length - 1; i++) {
                if (age >= age_keys[i] && age <= age_keys[i + 1]) {
                    age1 = age_keys[i];
                    age2 = age_keys[i + 1];
                    break;
                }
            }
            
            let thick1 = thickness_keys[0], thick2 = thickness_keys[thickness_keys.length - 1];
            for (let i = 0; i < thickness_keys.length - 1; i++) {
                if (thickness >= thickness_keys[i] && thickness <= thickness_keys[i + 1]) {
                    thick1 = thickness_keys[i];
                    thick2 = thickness_keys[i + 1];
                    break;
                }
            }
            
            const phi_11 = phi_table[age1][thick1];
            const phi_12 = phi_table[age1][thick2];
            const phi_21 = phi_table[age2][thick1];
            const phi_22 = phi_table[age2][thick2];
            const phi = bilinearInterpolate(age, thickness, age1, age2, thick1, thick2, phi_11, phi_12, phi_21, phi_22);
            
            const weight_50 = Math.max(0, Math.min(1, (80 - RH) / 30));
            const weight_80 = 1 - weight_50;
            
            const eps_cs_80_11 = eps_cs_table_80[age1][thick1];
            const eps_cs_80_12 = eps_cs_table_80[age1][thick2];
            const eps_cs_80_21 = eps_cs_table_80[age2][thick1];
            const eps_cs_80_22 = eps_cs_table_80[age2][thick2];
            const eps_cs_80 = bilinearInterpolate(age, thickness, age1, age2, thick1, thick2, eps_cs_80_11, eps_cs_80_12, eps_cs_80_21, eps_cs_80_22);
            
            const eps_cs_50_11 = eps_cs_table_50[age1][thick1];
            const eps_cs_50_12 = eps_cs_table_50[age1][thick2];
            const eps_cs_50_21 = eps_cs_table_50[age2][thick1];
            const eps_cs_50_22 = eps_cs_table_50[age2][thick2];
            const eps_cs_50 = bilinearInterpolate(age, thickness, age1, age2, thick1, thick2, eps_cs_50_11, eps_cs_50_12, eps_cs_50_21, eps_cs_50_22);
            
            const eps_cs = weight_80 * eps_cs_80 + weight_50 * eps_cs_50;
            
            return { phi: phi, eps_cs: eps_cs / 1000 };
        }

        // ==================== 计算σl6 ====================
        function calculateSigmaL6(eps_cs, phi, rho, e_p) {
            const i_squared = I_n / A_n;
            const rho_ps = 1 + (e_p * e_p) / i_squared;
            const shrinkage_stress = E_p * eps_cs;
            const creep_stress = alpha_EP * sigma_pc * phi;
            const denominator = 1 + 15 * rho * rho_ps;
            const sigma_l6 = 0.9 * (shrinkage_stress + creep_stress) / denominator;
            return {
                sigma_l6: sigma_l6,
                shrinkage_stress: shrinkage_stress,
                creep_stress: creep_stress,
                denominator: denominator
            };
        }

        // ==================== 参数配置 ====================
        const params = [
            { name: '收缩应变 εcs', unit: '(×10⁻³)', min: 0.12, max: 0.5, init: 0.22, step: 0.01, color: 'rgb(31, 119, 180)' },
            { name: '徐变系数 φ(t,t₀)', unit: '', min: 1.15, max: 3.78, init: 1.65, step: 0.05, color: 'rgb(255, 127, 14)' },
            { name: '配筋率 ρ', unit: '(×10⁻³)', min: 5, max: 20, init: 7.068, step: 0.1, color: 'rgb(44, 160, 44)' },
            { name: '偏心距 ep', unit: '(cm)', min: 20, max: 150, init: 82.524, step: 1, color: 'rgb(214, 39, 40)' },
            { name: '混凝土龄期 t₀', unit: '(天)', min: 3, max: 90, init: 28, step: 1, color: 'rgb(148, 103, 189)' },
            { name: '相对湿度 RH', unit: '(%)', min: 50, max: 90, init: 80, step: 1, color: 'rgb(140, 86, 75)' },
            { name: '理论厚度 h', unit: '(mm)', min: 100, max: 600, init: 200, step: 10, color: 'rgb(227, 119, 194)' }
        ];

        let currentValues = params.map(p => p.init);

        // ==================== 生成数据 ====================
        function generateData(paramIdx, paramValues) {
            const results = [];
            for (let val of paramValues) {
                let eps_cs, phi, rho, e_p;
                
                // 获取当前参数值
                const age = currentValues[4];
                const RH = currentValues[5];
                const thickness = currentValues[6];
                
                if (paramIdx === 0) {
                    // 拖动εcs滑块
                    eps_cs = val / 1000;
                    phi = currentValues[1];
                } else if (paramIdx === 1) {
                    // 拖动φ滑块
                    eps_cs = currentValues[0] / 1000;
                    phi = val;
                } else if (paramIdx === 2 || paramIdx === 3) {
                    // 拖动ρ或ep滑块，εcs和φ应该基于当前age/RH/h从表格查询 ✅
                    const tableResult = getPhiEpsFromTable(age, thickness, RH);
                    eps_cs = tableResult.eps_cs;
                    phi = tableResult.phi;
                } else {
                    // 拖动age/RH/thickness滑块，需要从表格查询φ和εcs
                    let queryAge = age;
                    let queryRH = RH;
                    let queryThickness = thickness;
                    
                    if (paramIdx === 4) queryAge = val;
                    else if (paramIdx === 5) queryRH = val;
                    else if (paramIdx === 6) queryThickness = val;
                    
                    const tableResult = getPhiEpsFromTable(queryAge, queryThickness, queryRH);
                    eps_cs = tableResult.eps_cs;
                    phi = tableResult.phi;
                }
                
                // 设置ρ和ep
                rho = (paramIdx === 2) ? val / 1000 : currentValues[2] / 1000;
                e_p = (paramIdx === 3) ? val : currentValues[3];
                
                const result = calculateSigmaL6(eps_cs, phi, rho, e_p);
                results.push(result.sigma_l6);
            }
            return results;
        }

        // ==================== 创建滑块和图表 ====================
        function createSlider(paramIdx) {
            const param = params[paramIdx];
            const container = document.createElement('div');
            container.className = 'slider-container';
            container.innerHTML = `
                <div class="slider-label">${param.name} ${param.unit}</div>
                <input type="range" id="slider${paramIdx}" 
                       min="${param.min}" max="${param.max}" 
                       value="${param.init}" step="${param.step}">
                <div class="slider-value" id="value${paramIdx}">${param.init.toFixed(3)}</div>
            `;
            return container;
        }

        function updateAllPlots() {
            // 获取当前实际使用的εcs和φ
            let eps_cs, phi;
            const age = currentValues[4];
            const RH = currentValues[5];
            const thickness = currentValues[6];
            
            // 从表格查询（用于显示和第4、5、6个参数图）
            const tableResult = getPhiEpsFromTable(age, thickness, RH);
            
            // 对于当前值显示，使用滑块值
            eps_cs = currentValues[0] / 1000;
            phi = currentValues[1];
            
            const currentResult = calculateSigmaL6(
                eps_cs, 
                phi, 
                currentValues[2] / 1000, 
                currentValues[3]
            );
            
            const shrinkContrib = currentResult.shrinkage_stress * 0.9 / currentResult.denominator;
            const creepContrib = currentResult.creep_stress * 0.9 / currentResult.denominator;
            
            document.getElementById('valueDisplay').innerHTML = 
                `当前预应力损失: σl6 = ${currentResult.sigma_l6.toFixed(2)} MPa (收缩贡献: ${shrinkContrib.toFixed(2)} MPa + 徐变贡献: ${creepContrib.toFixed(2)} MPa)`;
            
            // 更新7个参数图
            params.forEach((param, idx) => {
                const range = [];
                for (let v = param.min; v <= param.max; v += param.step) {
                    range.push(v);
                }
                
                const yData = generateData(idx, range);
                
                let currentX = currentValues[idx];
                let currentY;
                
                // 对于age/RH/h，需要重新计算当前Y值
                if (idx >= 4) {
                    // 使用表格查询的φ和εcs
                    currentY = calculateSigmaL6(
                        tableResult.eps_cs,
                        tableResult.phi,
                        currentValues[2] / 1000,
                        currentValues[3]
                    ).sigma_l6;
                } else {
                    // 对于εcs/φ/ρ/ep，使用滑块值计算的结果
                    currentY = currentResult.sigma_l6;
                }
                
                Plotly.react(`plot${idx}`, [{
                    x: range,
                    y: yData,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: param.color, width: 3 },
                    name: param.name
                }, {
                    x: [currentX],
                    y: [currentY],
                    type: 'scatter',
                    mode: 'markers',
                    marker: { color: 'red', size: 12 },
                    name: '当前值'
                }], {
                    title: `σl6 与 ${param.name} 的关系`,
                    xaxis: { title: `${param.name} ${param.unit}` },
                    yaxis: { title: 'σl6 (MPa)' },
                    showlegend: false,
                    margin: { l: 60, r: 20, t: 40, b: 50 },
                    height: 400
                }, { responsive: true });
            });
            
            // 更新敏感性分析图
            updateSensitivityPlot();
        }

        function updateSensitivityPlot() {
            const sensitivities = params.map((param, idx) => {
                const range = [];
                for (let v = param.min; v <= param.max; v += param.step) {
                    range.push(v);
                }
                const yData = generateData(idx, range);
                return Math.max(...yData) - Math.min(...yData);
            });
            
            const maxIdx = sensitivities.indexOf(Math.max(...sensitivities));
            const minIdx = sensitivities.indexOf(Math.min(...sensitivities));
            
            Plotly.react('sensitivity', [{
                x: params.map(p => p.name),
                y: sensitivities,
                type: 'bar',
                marker: {
                    color: params.map(p => p.color),
                    opacity: 0.7,
                    line: { color: 'black', width: 1.5 }
                },
                text: sensitivities.map(s => s.toFixed(1)),
                textposition: 'outside'
            }], {
                title: '各参数对σl6的影响程度对比（柱子越高影响越大）',
                xaxis: { title: '影响参数' },
                yaxis: { title: 'σl6 变化范围 (MPa)' },
                showlegend: false,
                margin: { l: 60, r: 20, t: 60, b: 80 },
                height: 500,
                annotations: [{
                    xref: 'paper',
                    yref: 'paper',
                    x: 0.98,
                    y: 0.97,
                    xanchor: 'right',
                    yanchor: 'top',
                    text: `最大影响: ${params[maxIdx].name} (Δσl6=${sensitivities[maxIdx].toFixed(1)} MPa)<br>最小影响: ${params[minIdx].name} (Δσl6=${sensitivities[minIdx].toFixed(1)} MPa)`,
                    showarrow: false,
                    bgcolor: 'lightyellow',
                    bordercolor: 'orange',
                    borderwidth: 2,
                    borderpad: 5,
                    font: { size: 12 }
                }]
            }, { responsive: true });
        }

        // ==================== 初始化 ====================
        params.forEach((param, idx) => {
            const plotDiv = document.getElementById(`plot${idx}`).parentElement;
            plotDiv.appendChild(createSlider(idx));
            
            const slider = document.getElementById(`slider${idx}`);
            const valueDisplay = document.getElementById(`value${idx}`);
            
            slider.addEventListener('input', (e) => {
                const newValue = parseFloat(e.target.value);
                currentValues[idx] = newValue;
                valueDisplay.textContent = newValue.toFixed(idx < 2 ? 3 : (idx === 2 ? 3 : (idx === 3 ? 1 : 0)));
                updateAllPlots();
            });
        });

        // 初始绘图
        updateAllPlots();
    </script>
</body>
</html>

